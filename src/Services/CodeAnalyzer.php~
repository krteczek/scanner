<?php
declare(strict_types=1);

namespace Scanner\Services;

class CodeAnalyzer
{
    private array $rules;
    
    public function __construct(array $rules)
    {
        $this->rules = $rules;
			//echo "\nconstruct rules: ";print_r($this->rules);
    }
    
    /**
     * Analyzuje všechny soubory v projektu
     * @return array [issues, stats]
     */
    public function analyzeProject(array $projectFiles, string $projectPath): array
    {
        $issues = [];
        $stats = [
            'files_analyzed' => 0,
            'issues_found' => 0,
            'by_severity' => ['critical' => 0, 'warning' => 0, 'info' => 0]
        ];
        
        foreach ($projectFiles as $file) {
            if (!$this->shouldAnalyze($file['extension'])) {
                continue;
            }
            
            $fileIssues = $this->analyzeFile($projectPath . '/' . $file['path'], $file['extension']);
            
            if (!empty($fileIssues)) {
                foreach ($fileIssues as &$issue) {
                    $issue['file'] = $file['path'];
                    $issue['file_name'] = $file['name'];
                }
                
                $issues = array_merge($issues, $fileIssues);
                $stats['issues_found'] += count($fileIssues);
                
                foreach ($fileIssues as $issue) {
                    $stats['by_severity'][$issue['severity']]++;
                }
            }
            
            $stats['files_analyzed']++;
        }
        
        return [
            'issues' => $issues,
            'stats' => $stats
        ];
    }
    
    private function analyzeFile(string $filePath, string $extension): array
    {
        if (!file_exists($filePath) || !is_readable($filePath)) {
            return [];
        }
        
        $content = file_get_contents($filePath);
        $issues = [];
        
        foreach ($this->rules as $ruleName => $rule) {
            if (!$this->ruleAppliesToExtension($rule, $extension)) {
					echo "\nneznámý nebo chybný patern rule, extension)): "; echo "\n rule: "; print_r($rule); echo "\n extension: ";print_r($extension);
                continue;
            }
            //echo "\n\n\nTOTO: "; print_r($rule);print_r($extension);
            if (preg_match($rule['pattern'], $content, $matches, PREG_OFFSET_CAPTURE)) {
                $line = $this->getLineNumber($content, $matches[0][1]);
                $snippet = $this->getCodeSnippet($content, $matches[0][1]);
                
                $issues[] = [
                    'rule_name' => $ruleName,
                    'message' => $rule['message'],
                    'severity' => $rule['severity'] ?? 'warning',
                    'line' => $line,
                    'snippet' => $snippet,
                    'pattern' => $rule['pattern']
                ];
            }
        }
        
        return $issues;
    }
    
    private function shouldAnalyze(string $extension): bool
    {
        $analyzable = ['php', 'js', 'html', 'css'];
        return in_array(strtolower($extension), $analyzable);
    }
    
    private function ruleAppliesToExtension(array $rule, string $extension): bool
    {
        if (empty($rule['extensions'])) {
            return true;
        }
        
        return in_array($extension, $rule['extensions']);
    }
    
    private function getLineNumber(string $content, int $offset): int
    {
        return substr_count(substr($content, 0, $offset), "\n") + 1;
    }
    
    private function getCodeSnippet(string $content, int $offset, int $context = 3): string
    {
        $lines = explode("\n", $content);
        $targetLine = $this->getLineNumber($content, $offset) - 1;
        
        $start = max(0, $targetLine - $context);
        $end = min(count($lines) - 1, $targetLine + $context);
        
        $snippetLines = [];
        for ($i = $start; $i <= $end; $i++) {
            $snippetLines[] = $lines[$i];
        }
        
        return implode("\n", $snippetLines);
    }
}